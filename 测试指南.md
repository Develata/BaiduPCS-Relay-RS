# MAX_ZIP_SIZE 功能测试指南

## 功能说明

新增的 `MAX_ZIP_SIZE` 环境变量可以限制 ZIP 压缩包的最大大小（按**未压缩**文件大小计算）。当文件总大小超过限制时，自动分割成多个 1GB 以下的压缩包。

## 环境配置

### 设置环境变量

```bash
# 在 Docker 容器中
export MAX_ZIP_SIZE=1048576        # 1MB (用于快速测试)
export MAX_ZIP_SIZE=10485760       # 10MB
export MAX_ZIP_SIZE=1073741824     # 1GB (推荐生产环境)
export MAX_ZIP_SIZE=2147483648     # 2GB (默认值)
```

### 启动服务器

```bash
# 停止现有服务器
docker exec rust-manual-run pkill -f baidu-web-server

# 启动服务器（带环境变量）
docker exec -d rust-manual-run bash -c \
  'cd /app && MAX_ZIP_SIZE=1048576 nohup ./target/release/baidu-web-server > /tmp/server.log 2>&1 &'

# 等待服务器启动
sleep 2

# 验证服务器启动
docker exec rust-manual-run ps aux | grep baidu-web
```

## 测试场景

### 场景 1：小文件（单个 ZIP）

**条件**：文件总大小 < MAX_ZIP_SIZE

**预期结果**：返回单个 ZIP 文件

```bash
# 测试请求
curl -X POST 'http://localhost:5200/api/zip' \
  -H 'Content-Type: application/json' \
  -d '{
    "fsids": [你的小文件fsid],
    "archive_name": "small_test",
    "token": "你的token"
  }' \
  -o /tmp/test_small.zip

# 验证
ls -lh /tmp/test_small.zip
file /tmp/test_small.zip
unzip -t /tmp/test_small.zip
```

### 场景 2：大文件（分卷 ZIP）

**条件**：文件总大小 > MAX_ZIP_SIZE

**预期结果**：返回 JSON 响应，包含分卷信息

```bash
# 设置小限制（例如 100KB）
docker exec rust-manual-run pkill -f baidu-web-server
docker exec -d rust-manual-run bash -c \
  'cd /app && MAX_ZIP_SIZE=102400 nohup ./target/release/baidu-web-server > /tmp/server.log 2>&1 &'
sleep 2

# 测试请求
curl -X POST 'http://localhost:5200/api/zip' \
  -H 'Content-Type: application/json' \
  -d '{
    "fsids": [你的大文件fsid],
    "archive_name": "large_test",
    "token": "你的token"
  }' | jq
```

**预期 JSON 响应示例**：

```json
{
  "success": true,
  "total_parts": 3,
  "parts": [
    {
      "part_num": 1,
      "filename": "large_test.z01",
      "size_bytes": 1048576
    },
    {
      "part_num": 2,
      "filename": "large_test.z02",
      "size_bytes": 1048576
    },
    {
      "part_num": 3,
      "filename": "large_test.z03",
      "size_bytes": 524288
    }
  ],
  "message": "文件过大，已分割为 3 个压缩包"
}
```

### 场景 3：文件夹下载

**条件**：包含多个文件的文件夹

```bash
curl -X POST 'http://localhost:5200/api/zip' \
  -H 'Content-Type: application/json' \
  -d '{
    "fsids": [你的文件夹fsid],
    "archive_name": "folder_test",
    "token": "你的token"
  }' -o /tmp/test_folder.zip
```

## 查看服务器日志

```bash
# 实时查看日志
docker exec rust-manual-run tail -f /tmp/server.log

# 查看最近日志
docker exec rust-manual-run tail -50 /tmp/server.log

# 搜索特定信息
docker exec rust-manual-run grep "MAX_ZIP_SIZE" /tmp/server.log
docker exec rust-manual-run grep "分割" /tmp/server.log
docker exec rust-manual-run grep "total_parts" /tmp/server.log
```

## 获取测试文件 fsid

### 方法 1：通过分享链接获取

```bash
# 访问百度网盘分享链接，获取 surl 和 pwd
# 例如：https://pan.baidu.com/s/1xxxxx 密码：abcd

# 使用 API 获取文件信息
curl -X POST 'http://localhost:5200/api/list' \
  -H 'Content-Type: application/json' \
  -d '{
    "surl": "你的surl",
    "pwd": "你的密码"
  }' | jq
```

### 方法 2：直接使用已知 fsid

如果你已经有 fsid，可以直接使用。

## 验证功能正常

### 检查点 1：配置读取

```bash
# 查看服务器启动日志
docker exec rust-manual-run grep -i "max_zip_size\|config" /tmp/server.log
```

### 检查点 2：单文件响应

```bash
# 小文件应该返回 ZIP 数据
curl -X POST ... | file -
# 输出应该包含: "Zip archive data"
```

### 检查点 3：分卷响应

```bash
# 大文件应该返回 JSON
curl -X POST ... | jq '.success'
# 输出应该是: true
```

### 检查点 4：响应头

```bash
# 单文件响应头
curl -I -X POST ...
# 应该包含: Content-Type: application/zip
# 应该包含: Content-Disposition: attachment; filename="xxx.zip"

# 分卷响应头
curl -I -X POST ...
# 应该包含: Content-Type: application/json
```

## 常见问题

### 问题 1：服务器未使用环境变量

**症状**：大文件仍然返回单个 ZIP

**解决方案**：
```bash
# 确认环境变量已设置
docker exec rust-manual-run bash -c 'echo $MAX_ZIP_SIZE'

# 重启服务器
docker exec rust-manual-run pkill -f baidu-web-server
docker exec -d rust-manual-run bash -c 'cd /app && MAX_ZIP_SIZE=102400 ./target/release/baidu-web-server'
```

### 问题 2：获取直链失败

**症状**：错误信息 "获取直链失败"

**原因**：分享链接已过期或 token 无效

**解决方案**：使用新的有效分享链接

### 问题 3：curl 返回乱码

**症状**：终端显示二进制数据

**原因**：服务器返回 ZIP 数据，这是正常的（说明返回的是单文件）

**解决方案**：
```bash
# 保存到文件
curl ... -o output.zip

# 或者只查看前几行
curl ... | head -50
```

## 快速测试命令

```bash
# 一键测试脚本
# 1. 设置 100KB 限制
docker exec rust-manual-run pkill -f baidu-web-server
docker exec -d rust-manual-run bash -c 'cd /app && MAX_ZIP_SIZE=102400 nohup ./target/release/baidu-web-server > /tmp/server.log 2>&1 &'
sleep 3

# 2. 测试请求（替换你的 fsid 和 token）
curl --max-time 60 -X POST 'http://localhost:5200/api/zip' \
  -H 'Content-Type: application/json' \
  -d '{"fsids": [你的fsid], "archive_name": "test", "token": "你的token"}' \
  | jq

# 3. 查看日志
docker exec rust-manual-run tail -20 /tmp/server.log
```

## 代码逻辑说明

1. **大小检查**：计算所有文件的**未压缩**总大小
2. **分割逻辑**：如果超过 `max_zip_size`，则分割成 1GB 以下的分卷
3. **并行压缩**：使用 `std::thread::scope` 并行压缩多个分卷
4. **响应格式**：
   - 单文件：`Content-Type: application/zip`
   - 多分卷：`Content-Type: application/json`

## 下一步

如需要自动下载分卷文件，可以使用前端 JavaScript 或编写脚本：

```javascript
// 前端示例
async function downloadParts(parts) {
  for (const part of parts) {
    const response = await fetch(`/api/download/${part.part_num}?token=xxx`);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = part.filename;
    a.click();
  }
}
```
